<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin Page Access Panel</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

<style>
  body { background: #0f0f0f; color: white; font-family: sans-serif; padding: 20px; max-width: 1200px; margin: 0 auto; }
  h1 { text-align: center; border-bottom: 1px solid #333; padding-bottom: 20px; }
  .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; margin-top: 30px; }
  .card { background: #1f1f1f; border: 1px solid #333; padding: 15px; border-radius: 8px; cursor: pointer; transition: 0.2s; text-align: center; }
  .card:hover { transform: translateY(-5px); border-color: #00bcd4; }
  .card h3 { margin: 10px 0 0 0; font-size: 16px; }
  
  /* Modal Styles (for user list) */
  #modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); z-index: 1000; align-items: center; justify-content: center; }
  .modal-content { background: #222; width: 100%; max-width: 500px; height: 80vh; border-radius: 12px; display: flex; flex-direction: column; border: 1px solid #444; padding: 20px; }
  .user-list { flex: 1; overflow-y: auto; margin: 20px 0; border-top: 1px solid #333; }
  .user-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 5px; border-bottom: 1px solid #333; }
  .user-info small { color: #888; display: block; }
  .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
  .switch input { opacity: 0; width: 0; height: 0; }
  .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #555; transition: .4s; border-radius: 34px; }
  .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
  input:checked + .slider { background-color: #00bcd4; }
  input:checked + .slider:before { transform: translateX(20px); }
  .close-btn { width: 100%; padding: 12px; background: #e53935; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
</style>
</head>
<body>

<h1>Admin Page Access Control</h1>
<p style="text-align: center; color: #aaa;">Click a Category Card to manage user access to the full page.</p>

<div class="grid" id="grid"></div>

<div id="modal">
  <div class="modal-content">
    <h3 id="modal-title" style="margin:0">Manage Access</h3>
    <p id="modal-subtitle" style="color:#aaa; font-size:12px; margin:5px 0 0 0;"></p>
    
    <div class="user-list" id="user-list">
      Loading users...
    </div>
    
    <button class="close-btn" onclick="document.getElementById('modal').style.display='none'">CLOSE PANEL</button>
  </div>
</div>

<script>
// 1. FIREBASE CONFIG
const firebaseConfig = {
  apiKey: "AIzaSyAs2S6iRhnYhmqNuF0QCCYu5NuzxHxIRv0",
  authDomain: "tvnstream-b4497.firebaseapp.com",
  databaseURL: "https://tvnstream-b4497-default-rtdb.firebaseio.com",
  projectId: "tvnstream-b4497",
  storageBucket: "tvnstream-b4497.appspot.com",
  messagingSenderId: "308384754214",
  appId: "1:308384754214:web:2938e76cd29b288f75d4e7",
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// 2. DEFINE PAGES/CATEGORIES (USE THE FILENAME AS THE ID)
const pageCategories = [
  { id: "jpnnewtour", name: "SEVENTEEN [NEW_] WORLD TOUR IN JAPAN", filename: "japannewtour" },
  // ADD MORE PAGES HERE. The 'id' must match the check in Part 2.
];

// 3. RENDER CARDS
const grid = document.getElementById('grid');
pageCategories.forEach(p => {
  const card = document.createElement('div');
  card.className = 'card';
  card.innerHTML = `
    <h3>${p.name}</h3>
    <small>Page: ${p.filename}</small>
  `;
  card.onclick = () => openModal(p);
  grid.appendChild(card);
});

// 4. MODAL LOGIC (User Listing and Toggling)
let currentPageId = null;

function openModal(page) {
  currentPageId = page.id;
  document.getElementById('modal-title').textContent = "Access for: " + page.name;
  document.getElementById('modal-subtitle').textContent = "Database Node: page_access/" + page.id;
  document.getElementById('modal').style.display = 'flex';
  const list = document.getElementById('user-list');
  list.innerHTML = '<div style="text-align:center; padding:20px;">Loading Database...</div>';

  Promise.all([
    db.ref('users').once('value'), // Assumes you save user profiles here
    db.ref('page_access/' + page.id).once('value')
  ]).then(([userSnap, permSnap]) => {
    const users = userSnap.val() || {};
    const perms = permSnap.val() || {};
    renderUserList(users, perms);
  });
}

function renderUserList(users, perms) {
  const list = document.getElementById('user-list');
  list.innerHTML = '';
  Object.entries(users).forEach(([uid, userData]) => {
    const hasAccess = perms[uid] === true;
    const row = document.createElement('div');
    row.className = 'user-row';
    row.innerHTML = `
      <div class="user-info">
        <strong>${userData.name || 'Unknown User'}</strong>
        <small>${userData.email || uid}</small>
      </div>
      <label class="switch">
        <input type="checkbox" ${hasAccess ? 'checked' : ''} onchange="toggleAccess('${uid}', this.checked)">
        <span class="slider"></span>
      </label>
    `;
    list.appendChild(row);
  });
}

window.toggleAccess = function(uid, isGranted) {
  if (!currentPageId) return;
  // Save to page_access -> pageID -> userID
  db.ref(`page_access/${currentPageId}/${uid}`).set(isGranted);
}
</script>
</body>
</html>
