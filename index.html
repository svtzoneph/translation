<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Page Access</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192.png">
<meta name="theme-color" content="#000000">
<style>
  body { background: #0f0f0f; color: white; font-family: sans-serif; padding: 20px; max-width: 1200px; margin: 0 auto; }
  h1 { text-align: center; border-bottom: 1px solid #333; padding-bottom: 20px; }
  
  /* Grid & Cards */
  .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; margin-top: 30px; }
  
  /* Updated Card Style */
  .card { 
    background: #1f1f1f; 
    border: 1px solid #333; 
    border-radius: 8px; 
    cursor: pointer; 
    transition: 0.2s; 
    text-align: center; 
    overflow: hidden; /* Ensures image corners stay rounded */
    padding: 0; /* Removed padding so image touches edges */
  }
  .card:hover { transform: translateY(-5px); border-color: #00bcd4; }
  
  /* New Image Style */
  .card-img {
    width: 100%;
    height: 140px; /* Fixed height for uniformity */
    object-fit: cover; /* Ensures image doesn't stretch weirdly */
    display: block;
    border-bottom: 1px solid #333;
  }

  /* Wrapper for the text inside the card */
  .card-content { padding: 15px; }
  .card h3 { margin: 0 0 5px 0; font-size: 16px; }
  
  /* Modal Styles */
  #modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); z-index: 1000; align-items: center; justify-content: center; }
  .modal-content { background: #222; width: 100%; max-width: 500px; height: 80vh; border-radius: 12px; display: flex; flex-direction: column; border: 1px solid #444; padding: 20px; }
  
  /* Search Bar Style */
  .search-bar { width: 100%; padding: 12px; margin: 15px 0 5px 0; background: #333; border: 1px solid #444; color: white; border-radius: 6px; box-sizing: border-box; outline: none; font-size: 14px; }
  .search-bar:focus { border-color: #00bcd4; }

  /* User List */
  .user-list { flex: 1; overflow-y: auto; margin: 10px 0 20px 0; border-top: 1px solid #333; }
  .user-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 5px; border-bottom: 1px solid #333; }
  .user-info small { color: #888; display: block; }
  
  /* Toggle Switch */
  .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
  .switch input { opacity: 0; width: 0; height: 0; }
  .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #555; transition: .4s; border-radius: 34px; }
  .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
  input:checked + .slider { background-color: #00bcd4; }
  input:checked + .slider:before { transform: translateX(20px); }
  
  .close-btn { width: 100%; padding: 12px; background: #e53935; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
</style>
</head>
<body>

<h1>Admin Page Access Control</h1>
<p style="text-align: center; color: #aaa;">Click a Category Card to manage user access to the full page.</p>

<div class="grid" id="grid"></div>

<div id="modal">
  <div class="modal-content">
    <h3 id="modal-title" style="margin:0">Manage Access</h3>
    <p id="modal-subtitle" style="color:#aaa; font-size:12px; margin:5px 0 0 0;"></p>
    
    <input type="text" id="search-input" class="search-bar" placeholder="ðŸ” Search user by name or email...">
    
    <div class="user-list" id="user-list">
      Loading users...
    </div>
    
    <button class="close-btn" onclick="document.getElementById('modal').style.display='none'">CLOSE PANEL</button>
  </div>
</div>

<script>
// 1. FIREBASE CONFIG
const firebaseConfig = {
  apiKey: "AIzaSyAs2S6iRhnYhmqNuF0QCCYu5NuzxHxIRv0",
  authDomain: "tvnstream-b4497.firebaseapp.com",
  databaseURL: "https://tvnstream-b4497-default-rtdb.firebaseio.com",
  projectId: "tvnstream-b4497",
  storageBucket: "tvnstream-b4497.appspot.com",
  messagingSenderId: "308384754214",
  appId: "1:308384754214:web:2938e76cd29b288f75d4e7",
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// 2. DEFINE PAGES/CATEGORIES
// REPLACE the 'image' URLs with your actual image links
const pageCategories = [
  { 
    id: "jpnnewtour", 
    name: "SEVENTEEN WORLD TOUR IN JAPAN", 
    filename: "japannewtour",
    image: "https://raw.githubusercontent.com/svtzoneph/gallery/main/images/website/new-tour.png" // Put your real image URL here
  },
  { 
    id: "live_access", // CHANGED THIS ID SO IT IS UNIQUE
    name: "LIVE ACCESS", 
    filename: "live",
    image: "https://placehold.co/600x400/1f1f1f/00bcd4?text=LIVE+STREAM" // Put your real image URL here
  },
];

// 3. RENDER CARDS
const grid = document.getElementById('grid');
pageCategories.forEach(p => {
  const card = document.createElement('div');
  card.className = 'card';
  // If the image link fails, it falls back to a grey box
  const imgSrc = p.image || "https://placehold.co/600x400/333/white?text=No+Image";

  card.innerHTML = `
    <img src="${imgSrc}" class="card-img" alt="${p.name}">
    <div class="card-content">
      <h3>${p.name}</h3>
      <small>Page: ${p.filename}</small>
    </div>
  `;
  card.onclick = () => openModal(p);
  grid.appendChild(card);
});

// 4. MODAL LOGIC
let currentPageId = null;
const searchInput = document.getElementById('search-input');

function openModal(page) {
  currentPageId = page.id;
  
  document.getElementById('modal-title').textContent = "Access for: " + page.name;
  document.getElementById('modal-subtitle').textContent = "Database Node: page_access/" + page.id;
  document.getElementById('modal').style.display = 'flex';
  
  searchInput.value = '';
  
  const list = document.getElementById('user-list');
  list.innerHTML = '<div style="text-align:center; padding:20px;">Loading Database...</div>';

  Promise.all([
    db.ref('users').once('value'), 
    db.ref('page_access/' + page.id).once('value')
  ]).then(([userSnap, permSnap]) => {
    const users = userSnap.val() || {};
    const perms = permSnap.val() || {};
    renderUserList(users, perms);
  });
}

function renderUserList(users, perms) {
  const list = document.getElementById('user-list');
  list.innerHTML = '';
  
  Object.entries(users).forEach(([uid, userData]) => {
    const hasAccess = perms[uid] === true;
    const row = document.createElement('div');
    row.className = 'user-row';
    row.innerHTML = `
      <div class="user-info">
        <strong>${userData.name || 'Unknown User'}</strong>
        <small>${userData.email || uid}</small>
      </div>
      <label class="switch">
        <input type="checkbox" ${hasAccess ? 'checked' : ''} onchange="toggleAccess('${uid}', this.checked)">
        <span class="slider"></span>
      </label>
    `;
    list.appendChild(row);
  });
}

searchInput.addEventListener('keyup', (e) => {
  const term = e.target.value.toLowerCase();
  const rows = document.querySelectorAll('.user-row');
  rows.forEach(row => {
    const text = row.innerText.toLowerCase();
    row.style.display = text.includes(term) ? 'flex' : 'none';
  });
});

window.toggleAccess = function(uid, isGranted) {
  if (!currentPageId) return;
  db.ref(`page_access/${currentPageId}/${uid}`).set(isGranted);
}
</script>

<script>
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("/sw.js").then((registration) => {
      registration.update();
      registration.onupdatefound = () => {
        const installingWorker = registration.installing;
        installingWorker.onstatechange = () => {
          if (installingWorker.state === "installed") {
            if (navigator.serviceWorker.controller) {
              console.log("New content available, reloading...");
              window.location.reload();
            }
          }
        };
      };
    });
  }
</script>
  
</body>
</html>
